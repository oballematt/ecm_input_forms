let attributes,analysisIndex,sliderStartTime,sliderEnd,data=[],replaceData=[],d2=new Date,endTime=new Date().toISOString().slice(0,10),startTime=new Date(d2.getFullYear()-2,d2.getMonth()-1,1).toISOString().slice(0,10);$(document).ready(()=>{console.log(startTime);const a=$(".datepicker");a.datepicker({changeYear:!0,dateFormat:"yy-mm-dd"}),$(".load").on("click",function(){$("#overlay").fadeIn()}),$(".modelStart").on("change",function(){let a=$(this).datepicker("getDate");a.setDate(a.getDate()+364),$(".modelEnd").datepicker("setDate",a)});let b=$("#table"),c=$("#table2"),d=$("#button"),e=$("#button3");$("#filterBy").on("change",function(){b.bootstrapTable("filterBy",{building_number:$(this).val()})}),$(".reset").on("click",function(){b.bootstrapTable("filterBy",{}),$("#filterBy").val("Filter By")}),$(function(){let a=!1;b.on("change",$("input[name=\"btSelectItem\"]"),function(){a=!0,data=[]}),d.click(function(){if(!1===a)alert("Please select a meter");else{let a=new Date,c=new Date,d=new Date,e=new Date;a.setDate(1),a.setMonth(a.getMonth()-1),a.setYear(a.getFullYear()-1),c.setDate(1),c.setMonth(c.getMonth()-1),c.setYear(c.getFullYear()-1),c.setDate(364),d.setDate(1),d.setMonth(d.getMonth()-1),e.setDate(0),e.setMonth(e.getMonth()),$(".modelStart").datepicker("setDate",a),$(".modelEnd").datepicker("setDate",c),$(".analysisStart").datepicker("setDate",d),$(".analysisEnd").datepicker("setDate",e),data.push(b.bootstrapTable("getSelections")),$(".disabled").attr("disabled",!1),$(".meterSelection").html(`${data[0][0].meter}`)}})}),$(".pointer").on("click",function(){$("#filterBy").empty();const a=$(this).text();$.ajax({type:"POST",url:"/buildings",data:{steward:a}}).then(function(b){$("#filterBy").append("<option selected disabled>Choose...</option>"),b.map(b=>{$("#filterBy").append(`<option value=${b.building_id}>${b.building}</option>`)}),$(".dropdown-toggle").text(a)})});const f=function(){const a={meter:$(".currentMeter").text()};$.ajax({type:"POST",url:"/getAttributes",data:a}).then(a=>{console.log(a),0===a.length?$(".attributesSubmitted").html(`<h6 class="text-warning"><strong>Attributes have not been submitted for this meter</strong></h6>`):$(".attributesSubmitted").html(`<h6 style="color: #00B74A"><strong>Attributes last submitted on: ${new Date(a[0].updated_at).toLocaleString()}</strong></h6>`),attributes=a})};$(".apiGateway").on("click",function(a){a.preventDefault(),0===data.length?(alert("No meter selected. Please click \"Confirm Meter Selection\" to confirm your selected meter"),$("#overlay").hide()):(!0===h&&i(),$("#chartData").load(location.href+" #chartData"),$("#chartData2").load(location.href+" #chartData2"),$("#chartData3").load(location.href+" #chartData3"),$(".tableData").load(location.href+" .tableData"),$("#collapseRow").load(location.href+" #collapseRow"),g())});const g=function(){const a=$(".modelStart").val(),b=$(".modelEnd").val(),c=$(".analysisStart").val(),d=$(".analysisEnd").val(),e=data[0][0].building_number,i=data[0][0].commodity_tag,j=data[0][0].meter;$.when($.ajax({url:"/getModel",method:"GET",data:{buildingNumber:data[0][0].building_number,commodity:data[0][0].commodity_tag,meter:data[0][0].meter,trainStart:a,trainEnd:b,analysisStart:c,analysisEnd:d},error:function(a){504===a.status&&(g(),$(".overlayMessage").text("Server not responding, trying your search again. Please do not refresh the page")),502===a.status&&($("#overlay").fadeOut(),alert("No data was returned for your current search criteria. Please try selecting a different meter or date range"))}}),$.ajax({url:"/getConsumption",method:"GET",data:{buildingNumber:e,commodity:i,meter:j,startTimestamp:startTime,endTimestamp:endTime}})).then((a,b)=>{if("Request failed with status code 504"===a[0]||"Request failed with status code 500"===a[0]||"Request failed with status code 504"===b[0])g(),$(".overlayMessage").text("Server not responding, trying your search again. Please do not refresh the page");else if(401===a)alert("You are not authorized");else{function e(){var a=new google.visualization.DataTable;a.addColumn("date"),a.addColumn("number"),I.forEach(b=>{a.addRow([new Date(b[0]),b[1]])});var b=new google.visualization.Dashboard(document.getElementById("dashboard")),c=new google.visualization.ControlWrapper({controlType:"ChartRangeFilter",containerId:"control_div",options:{filterColumnIndex:0,ui:{chartType:"ScatterChart",chartOptions:{height:"100",width:"90%",colors:["#15A0C8"],backgroundColor:{fill:"#48555F"},chartArea:{height:"100",width:"90%"},hAxis:{baselineColor:"#FFFFFF",gridlineColor:"#FFFFFF",textStyle:{color:"#FFF"}}}}}});var d=new google.visualization.ChartWrapper({chartType:"ScatterChart",containerId:"chart_div",options:{legend:"none",tooltip:{isHtml:!0,trigger:"hover"},pointSize:10,dataOpacity:1,colors:["#15A0C8"],vAxis:{baselineColor:"#000000",gridlineColor:"#000000",textStyle:{color:"#FFF"}},hAxis:{baselineColor:"#000000",gridlineColor:"#000000",textStyle:{color:"#FFF"}},height:600,width:1e3,backgroundColor:{fill:"#48555F"}}});(function(a){a.setOption("width","90%"),a.setOption("chartArea.width","90%")})(d),b.bind([c],[d]),$(".show-hide").on("click",function(){const c=this.querySelector("i"),d=this.querySelector("span");b.draw(a),c.classList.contains("fa-eye")?(c.classList.remove("fa-eye"),c.classList.add("fa-eye-slash"),d.innerHTML="Hide Historic"):(c.classList.remove("fa-eye-slash"),c.classList.add("fa-eye"),d.innerHTML="Show Historic")}),google.visualization.events.addListener(c,"statechange",function(){var a=c.getState();return document.getElementById("dbgchart").innerHTML=a.range.start.toISOString().slice(0,10)+" to "+a.range.end.toISOString().slice(0,10),0})}$(".displayData").show(),console.log(a),console.log(b),h=!0;const g=a[0].body.model.data.timestamp.indexOf($(".analysisStart").val());let j=a[0].body.model.data.predicted_value_lower_bound.slice(g),k=a[0].body.model.data.average_dry_bulb_temperature.slice(g),l=a[0].body.model.data.predicted_value_upper_bound.slice(g),m=a[0].body.model.data.raw_value.slice(g),n=a[0].body.model.data.timestamp.slice(g),o={},p={};$(".overlayMessage").text("Getting data, this will take a few seconds"),$("#overlay").fadeOut(),$(".baseTemp").html(a[0].body.model.base_temperature),$(".autoIgnored").html(parseFloat(a[0].body.model.missing_value.auto_ignored_percentage).toFixed(0)+"%"),$(".slope").html(parseFloat(a[0].body.model.slope).toFixed(2)),$(".intercept").html(parseFloat(a[0].body.model.intercept).toFixed(2)),$(".r2").html(parseFloat(a[0].body.model.max_train_r2).toFixed(2)),$(".stdDev").html(parseFloat(a[0].body.model.std.train).toFixed(2)),$(".meterVariable").html(`Variable: ${a[0].body.model.x.toUpperCase()}`),$(".currentMeter").text(data[0][0].meter),$(".currentBuilding").text(data[0][0].building_number),$(".currentCommodity").text(data[0][0].commodity_tag),$(".currentVariable").text(a[0].body.model.x),f();const q=(a=>a.filter((b,c)=>a.indexOf(b)!==c))(k);console.log(q),k.forEach((a,b)=>o[a]=j[b]);var c=Object.keys(o).map(function(a){return[+a,o[a]]});c.sort(function(c,a){return c[0]-a[0]}),k.forEach((a,b)=>o[a]=l[b]);let r=Object.keys(o).map(function(a){return[+a,o[a]]});r.sort(function(c,a){return c[0]-a[0]}),k.forEach((a,b)=>{o[a]=m[b]});let s=Object.keys(o).map(function(a){return[+a,o[a]]});s.sort(function(c,a){return c[0]-a[0]}),"W"===data[0][0].commodity_tag&&($("#hideIfWater").hide(),$("#fullWidth").attr("class","col-xxl-12"),$("#myChart2").css("height","400px"));const t={data:{datasets:[{type:"scatter",label:"Meter VS. Temp",data:s.map(b=>({x:b[0],y:Math.trunc(b[1])})),backgroundColor:"#00FFFF",pointRadius:5},{type:"line",label:"High Limit",data:r.map(b=>({x:b[0],y:b[1]})),fill:!1,pointRadius:0,tension:.1,borderColor:"white"},{type:"line",label:"Low Limit",data:c.map(b=>({x:b[0],y:b[1]})),fill:!1,pointRadius:0,tension:.1,borderColor:"#ffcc66"}]},options:{plugins:{legend:{labels:{color:"white"}}},scales:{y:{beginAtZero:!0,ticks:{color:"white"},grid:{color:"black"}},x:{ticks:{color:"white"},grid:{color:"black"}}},onClick(a){const b=v.getElementsAtEventForMode(a,"nearest",{intersect:!0},!1),[{index:c}]=b;var d=$(".scroll"),e=$("#"+t.data.datasets[0].data[c].y);d.animate({scrollTop:e.offset().top-d.offset().top+d.scrollTop()-d.height()/2}),e.parent("tr").effect("highlight",{},3e3)}}};let u=document.getElementById("myChart").getContext("2d"),v=new Chart(u,t),w=document.getElementById("myChart3").getContext("2d"),x=new Chart(w,t);n.forEach((a,b)=>p[a]=m[b]);let y=Object.keys(p).map(function(a){return[a+"",p[a]]});y.sort(function(c,a){return c[0]-a[0]}),n.forEach((a,b)=>p[a]=l[b]);let z=Object.keys(p).map(function(a){return[a+"",p[a]]});z.sort(function(c,a){return c[0]-a[0]}),n.forEach((a,b)=>p[a]=j[b]);var d=Object.keys(p).map(function(a){return[a+"",p[a]]});d.sort(function(c,a){return c[0]-a[0]});const A={data:{datasets:[{type:"scatter",label:"Meter VS. Dates",data:y.map(b=>({x:b[0],y:Math.trunc(b[1])})),pointRadius:5,backgroundColor:"#00FFFF"},{type:"line",label:"High Limit",data:z.map(b=>({x:b[0],y:b[1]})),fill:!1,pointRadius:0,borderColor:"white",tension:.1},{type:"line",label:"Low Limit",data:d.map(b=>({x:b[0],y:b[1]})),fill:!1,pointRadius:0,borderColor:"#ffcc66",tension:.1}]},options:{plugins:{legend:{labels:{color:"white"}}},scales:{x:{type:"time",time:{unit:"day"},ticks:{color:"white"},grid:{color:"black"}},y:{beginAtZero:!0,ticks:{color:"white"},grid:{color:"black"}}},onClick(a){const b=C.getElementsAtEventForMode(a,"nearest",{intersect:!0},!1),[{index:c}]=b;var d=$(".scroll"),e=$("#"+A.data.datasets[0].data[c].y);d.animate({scrollTop:e.offset().top-d.offset().top+d.scrollTop()-d.height()/2}),e.parent("tr").effect("highlight",{},3e3)}}};let B=document.getElementById("myChart2").getContext("2d"),C=new Chart(B,A),D=document.getElementById("myChart4").getContext("2d"),E=new Chart(D,A);$(function(){const b=a[0].body.model.data.timestamp.slice(g),c=a[0].body.model.data.average_dry_bulb_temperature.slice(g),d=a[0].body.model.data.degree_day.slice(g),e=a[0].body.model.data.is_occupied.slice(g),f=a[0].body.model.data.raw_value.slice(g),h=a[0].body.model.data.predicted_value.slice(g),i=a[0].body.model.data.replacement_value.slice(g),j=a[0].body.model.data.replacement_reason.slice(g),k=a[0].body.model.data.replacement_notes.slice(g),l=a[0].body.model.data.predicted_value_lower_bound.slice(g),m=a[0].body.model.data.predicted_value_upper_bound.slice(g);b.map((a,b)=>{$(".tableBody").append(`
                    <tr>
                        <td class='position'><input class="form-check-input edit" name='edit' type="checkbox"></td>
                        <td class='date'>${a}</td>
                        <td>${c[b]}</td>
                        <td>${"occ"===$(".currentVariable").text()?e[b]:parseFloat(d[b]).toFixed(0)}</td>
                        <td id=${Math.trunc(f[b])} class='meterReading'>${Math.trunc(f[b])}</td>
                        <td class='expected'>${parseFloat(h[b]).toFixed(0)}</td>
                        <td >${null===i[b]?"-":parseFloat(i[b]).toFixed(0)}</td>
                        <td>${null===j[b]?"-":j[b]}</td>
                        <td>${null===k[b]?"-":k[b]}</td>
                        <td class="upperBound" style='display: none'>${parseFloat(m[b]).toFixed(0)}</td>
                        <td class="lowerBound" style='display: none'>${parseFloat(l[b]).toFixed(0)}</td>
                    </tr>`)}),$(".x").html(a[0].body.model.x.toUpperCase()),$(".tableData tbody tr").each(function(){let a=$(this).find(".meterReading").html(),b=$(this).find(".lowerBound").html(),c=$(this).find(".upperBound").html();parseInt(a,10)<parseInt(b,10)&&($(this).addClass("table-warning"),0===$(this).index()?$(this).children("td:eq(0)").append(`<a href="#" class="warning firstRow" data-tool-tip="Low Limit: ${b}"><i class="fas fa-exclamation-circle fa-2x"></i></a>`):$(this).children("td:eq(0)").append(`<a href="#" class="warning" data-tool-tip="Low Limit: ${b}"><i class="fas fa-exclamation-circle fa-2x"></i></a>`)),parseInt(a,10)>parseInt(c,10)&&($(this).addClass("table-danger"),0===$(this).index()?$(this).children("td:eq(0)").append(`<a href="#" class="warning firstRow" data-tool-tip="High Limit: ${c}"><i class="fas fa-exclamation-circle fa-2x"></i></a>`):$(this).children("td:eq(0)").append(`<a href="#" class="warning" data-tool-tip="High Limit: ${c}"><i class="fas fa-exclamation-circle fa-2x"></i></a>`)),$(this).children("td:eq(4)").text()===$(this).next().children("td:eq(4)").text()&&($(this).addClass("table-primary"),$(this).next().addClass("table-primary"))})});const F={},G=b[0].body.timestamp,H=b[0].body.value;G.forEach((a,b)=>F[a]=H[b]);const I=Object.keys(F).map(function(a){return[a+"",F[a]]});google.load("visualization","1",{packages:["controls","charteditor"]}),google.setOnLoadCallback(e)}})};$("#reason").on("change",function(){e.removeAttr("disabled")}),e.click(function(){$("input:checkbox:checked",$(".tableData")).each(function(){replaceData.push({Date:$(this).closest("tr").find(".date").text(),Expected:$(this).closest("tr").find(".expected").text(),index:$(this).closest("tr").index()})}).get();let a=$("#replace").is(":checked"),b=[],c=[],d=[],e=[];const f=$(".email").text().trim(),g=data[0][0].building_number,h=data[0][0].commodity_tag,i=data[0][0].meter;console.log(replaceData),0===replaceData.length?(alert("Please select at least one date"),$("#overlay").hide()):(!0===a?replaceData.forEach(function(a){""===$("#notes").val()?b.push(null):b.push($("#notes").val()),c.push($("#reason").val()),d.push(parseFloat(a.Expected)),e.push(a.Date)}):replaceData.forEach(function(a){""===$("#notes").val()?b.push(null):b.push($("#notes").val()),c.push($("#reason").val()),d.push(null),e.push(a.Date)}),$(".overlayMessage").text("Submitting Data. Please wait..."),$.ajax({url:"/postModel",method:"POST",data:{analyst:f,building_number:g,commodity_tag:h,meter:i,timestamp:JSON.stringify(e),values:JSON.stringify(d),reason:JSON.stringify(c),notes:JSON.stringify(b)},error:function(a){400===a.status&&(alert("Invalid Request. Please try again."),$("#overlay").fadeOut()),504===a.status&&($("#overlay").fadeOut(),$(".edit").prop("checked",!1),alert("Server Error. Your data has been saved. Please hit the submit button again."))}}).then(a=>{replaceData.forEach((a,e)=>{const f=$(`.tableData tbody tr:eq(${a.index})`),g=a=>f.children(`td:eq(${a})`);g(6).text(null===d[e]?"-":d[e]),g(7).text(c[e]),g(8).text(null===b[e]?"-":b[e])}),console.log(a),$("#overlay").fadeOut(),$(".overlayMessage").text("Getting data, this will take a few seconds"),b=[],e=[],d=[],c=[],replaceData=[],$(".edit").prop("checked",!1),$("#replace").prop("checked",!1),$("#notes").val(""),$("#reason").val("Choose..."),$(".successAlert").html(`<div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Success!</strong> Your data has been successfully uploaded!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`)}))}),$(".logout").click(function(){!0===h&&i()}),window.onbeforeunload=function(){!0===h&&i()};let h=!1;const i=()=>{let a=$(".autoIgnored").text(),b=a.substring(0,a.length-1);const c=$(".currentBuilding").text(),d=$(".currentMeter").text(),e=$(".currentCommodity").text(),f=$(".meterVariable").text(),g=$(".currentVariable").text();let h=$(".baseTemp").text();const i=+b,j=+$(".slope").text(),k=+$(".intercept").text(),l=+$(".r2").text(),m=+$(".stdDev").text(),n=$(".modelStart").val(),o=$(".modelEnd").val();if(h=""===h?null:+$(".baseTemp").text(),0===attributes.length||attributes[0].base_temperature!==h||attributes[0].intercept!==k||attributes[0].slope!==j||attributes[0].auto_ignored_percentage!==i||attributes[0].r2!==l||attributes[0].std!==m||attributes[0].train_start!==n||attributes[0].train_end!==o){const a=confirm(`Do you want to submit the current meter attributes for meter: ${$(".currentMeter").text()}

            \u2022 Variable: ${f}
            \u2022 Base Temp: ${h}
            \u2022 Auto Ignored: ${i}
            \u2022 Slope: ${j}
            \u2022 Intercept: ${k}
            \u2022 R-Squared: ${l}
            \u2022 Std Dev: ${m}`);!0===a&&$.ajax({type:"POST",url:"/postAttributes",data:{building_number:c,meter:d,commodity_tag:e,train_start:n,train_end:o,x:g,auto_ignored_percentage:i,base_temperature:0===h?null:h,r2:l,slope:j,intercept:k,std:m}}).then(a=>{console.log(a)})}}});